# 基于NVIDIA CUDA镜像
FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    tree \
    unzip \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    openssh-server \
    sudo \
    locales \
    tzdata \
    python3 \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# 配置时区
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 安装Python依赖
RUN pip3 install --upgrade pip setuptools wheel

# 安装常用Python包
RUN pip3 install \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    scikit-learn \
    tensorflow \
    torch \
    torchvision \
    torchaudio \
    jupyter \
    jupyterlab \
    tensorboard \
    opencv-python \
    pillow \
    requests \
    tqdm \
    ipywidgets \
    plotly \
    dash

# 安装Node.js依赖（用于VSCode Server）
RUN npm install -g npm@latest

# 配置SSH
RUN mkdir /var/run/sshd
RUN echo 'root:root' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 创建工作目录
RUN mkdir -p /shared /workspace
RUN chmod 755 /shared /workspace

# 下载并安装code-server (VSCode Server)
RUN curl -fsSL https://code-server.dev/install.sh | sh

# 复制启动脚本
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# 暴露端口
# SSH: 22
# VSCode Server: 8080  
# Jupyter Lab: 8888
# TensorBoard: 6006
EXPOSE 22 8080 8888 6006

# 设置启动脚本
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]