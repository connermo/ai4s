# åŸºäºNVIDIA CUDA 12.4 + cuDNNåŸºç¡€é•œåƒ
FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæœ€ç¨³å®šçš„å±‚ï¼‰
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Shanghai \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    CONDA_ALWAYS_YES=true \
    CONDA_AUTO_ACTIVATE_BASE=false \
    CONDA_CHANNELS="conda-forge,pytorch,nvidia,defaults"

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    tree \
    unzip \
    bzip2 \
    ca-certificates \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release \
    openssh-server \
    sudo \
    locales \
    tzdata \
    haveged \
    && rm -rf /var/lib/apt/lists/*

# é…ç½®æ—¶åŒºï¼ˆç¨³å®šï¼‰
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å®‰è£…Python 3.11ï¼ˆè¾ƒç¨³å®šï¼‰
RUN add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y \
    python3.11 \
    python3.11-venv \
    python3.11-dev \
    python3.11-distutils \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…pip for Python 3.11ï¼ˆåˆ†ç¦»ä¸‹è½½å’Œå®‰è£…ï¼‰
RUN curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py \
    && python3.11 get-pip.py \
    && rm get-pip.py \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 100 \
    && update-alternatives --install /usr/bin/pip3 pip3 /usr/local/bin/pip3.11 100

# å®‰è£…Node.js 20.x LTSï¼ˆè¾ƒç¨³å®šï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# å‡çº§pipå¹¶å®‰è£…åŸºç¡€å·¥å…·ï¼ˆç¨³å®šï¼‰
RUN pip3 install --upgrade pip setuptools wheel

# å®‰è£…Minicondaï¼ˆç¨³å®šï¼‰
RUN wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh \
    && bash /tmp/miniconda.sh -b -p /opt/miniconda3 \
    && rm /tmp/miniconda.sh

# è®¾ç½®condaç¯å¢ƒå˜é‡å’Œé…ç½®ï¼ˆç¨³å®šï¼‰
ENV PATH="/opt/miniconda3/bin:$PATH"
RUN conda init bash \
    && conda config --add channels conda-forge \
    && conda config --add channels pytorch \
    && conda config --add channels nvidia \
    && conda config --set show_channel_urls yes \
    && conda config --set auto_activate_base false \
    && conda config --set always_yes true \
    && conda config --set channel_priority strict \
    && conda clean -afy

# åˆ›å»ºé¢å¤–çš„Pythonç¯å¢ƒï¼ˆé¢„ç•™ç»™ç”¨æˆ·è‡ªå®šä¹‰ä½¿ç”¨ï¼‰
RUN conda create -n ml python=3.11 -y && conda clean -afy

# è®¾ç½®CUDAç¯å¢ƒå˜é‡ï¼ˆç¨³å®šï¼‰
ENV CUDA_HOME=/usr/local/cuda \
    LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/targets/x86_64-linux/lib:${LD_LIBRARY_PATH} \
    PATH=/usr/local/cuda/bin:${PATH}

# å®‰è£…åŸºç¡€ç§‘å­¦è®¡ç®—åŒ…ï¼ˆç‰ˆæœ¬ç›¸å¯¹ç¨³å®šï¼‰
RUN pip3 install --no-cache-dir \
    "numpy>=1.24.0" \
    "pandas>=2.0.0" \
    "matplotlib>=3.7.0" \
    "scikit-learn>=1.3.0" \
    "seaborn>=0.11.0"

# å®‰è£…Jupyterç›¸å…³åŒ…ï¼ˆç‰ˆæœ¬ç›¸å¯¹ç¨³å®šï¼‰
RUN pip3 install --no-cache-dir \
    "jupyter>=1.0.0" \
    "jupyterlab>=4.0.0" \
    "notebook>=6.5.0" \
    "ipywidgets>=8.0.0" \
    "ipykernel"

# å®‰è£…PyTorchï¼ˆè¾ƒå¤§ï¼Œå•ç‹¬ä¸€å±‚ï¼‰
RUN pip3 install --no-cache-dir torch==2.6.0 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124

# TensorFlowå·²ç§»é™¤ï¼ŒPyTorchä½œä¸ºä¸»è¦æ·±åº¦å­¦ä¹ æ¡†æ¶
# ç”¨æˆ·å¯åœ¨mlç¯å¢ƒä¸­æ ¹æ®éœ€è¦è‡ªè¡Œå®‰è£…TensorFlow

# å®‰è£…AI/MLç›¸å…³åŒ…ï¼ˆç‰ˆæœ¬å¯èƒ½å˜åŒ–ï¼‰
RUN pip3 install --no-cache-dir \
    "opencv-python-headless>=4.5.0" \
    "plotly>=5.14.0" \
    "transformers>=4.20.0" \
    "datasets>=2.0.0" \
    "accelerate>=0.20.0"

# å®‰è£…Webæ¡†æ¶åŒ…ï¼ˆç‰ˆæœ¬å¯èƒ½å˜åŒ–ï¼‰
RUN pip3 install --no-cache-dir \
    "wandb>=0.15.0" \
    "flask>=2.0.0" \
    "fastapi>=0.95.0" \
    "uvicorn>=0.20.0"

# é…ç½®condaæƒé™
RUN chmod -R 777 /opt/miniconda3/envs/ml \
    && mkdir -p /opt/miniconda3/pkgs && chmod -R 777 /opt/miniconda3/pkgs

# åˆ›å»ºCUDAåº“ç¬¦å·é“¾æ¥
RUN ln -sf /usr/lib/x86_64-linux-gnu/libcudnn* /usr/local/cuda/lib64/ 2>/dev/null || true \
    && ln -sf /usr/lib/x86_64-linux-gnu/libcuda.so.1 /usr/local/cuda/lib64/libcuda.so.1 \
    && ln -sf /usr/lib/x86_64-linux-gnu/libcuda.so.1 /usr/local/cuda/lib64/libcuda.so \
    && ldconfig

# å®‰è£…JupyterLabæ‰©å±•ï¼ˆå¯èƒ½å¤±è´¥ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼‰
RUN jupyter labextension install @plotly/plotly-jupyterlab-extension --no-build || true \
    && jupyter lab build --dev-build=False --minimize=False || true

# é…ç½®SSHï¼ˆç³»ç»Ÿé…ç½®ï¼‰
RUN mkdir /var/run/sshd \
    && echo 'root:root' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config \
    && echo "UseDNS no" >> /etc/ssh/sshd_config \
    && echo "GSSAPIAuthentication no" >> /etc/ssh/sshd_config \
    && service haveged start \
    && ssh-keygen -A \
    && service haveged stop

# åˆ›å»ºå·¥ä½œç›®å½•
RUN mkdir -p /shared /workspace && chmod 755 /shared /workspace

# å®‰è£…code-serverï¼ˆå¯èƒ½å˜åŒ–çš„å¤–éƒ¨ä¾èµ–ï¼‰
RUN curl -fsSL https://code-server.dev/install.sh | sh

# è¶…å¿«æ‰©å±•å®‰è£…ï¼šå…¨å¹¶è¡Œ + å¿«é€Ÿå¤±è´¥ + æœ€å°é›†åˆ
RUN mkdir -p /tmp/extensions \
    && echo "ğŸš€ å¹¶è¡Œå®‰è£…VSCodeæ‰©å±•ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰..." \
    && export NODE_OPTIONS="--max-old-space-size=2048" \
    # å…¨å¹¶è¡Œå®‰è£…ï¼ˆ30ç§’è¶…æ—¶ï¼Œå¿«é€Ÿå¤±è´¥ï¼‰
    && ( \
        timeout 30 code-server --install-extension ms-python.python --extensions-dir /tmp/extensions --force & \
        timeout 30 code-server --install-extension ms-toolsai.jupyter --extensions-dir /tmp/extensions --force & \
        timeout 30 code-server --install-extension ms-vscode.vscode-json --extensions-dir /tmp/extensions --force & \
        timeout 30 code-server --install-extension redhat.vscode-yaml --extensions-dir /tmp/extensions --force & \
        wait \
    ) \
    && echo "âœ… å¿«é€Ÿå®‰è£…å®Œæˆï¼Œå·²å®‰è£…æ‰©å±•æ•°é‡: $(find /tmp/extensions -maxdepth 1 -type d | grep -v "^/tmp/extensions$" | wc -l)" \
    && chmod -R 755 /tmp/extensions

# å¤åˆ¶è„šæœ¬æ–‡ä»¶ï¼ˆæœ€ç»å¸¸å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ”¾åœ¨æœ€åï¼‰
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
COPY docker/test_environments.sh /usr/local/bin/test_environments.sh
COPY debug-vscode-extensions.sh /usr/local/bin/debug-vscode-extensions.sh
COPY docker/change-password.sh /usr/local/bin/change-password.sh
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/test_environments.sh /usr/local/bin/change-password.sh /usr/local/bin/debug-vscode-extensions.sh

# æš´éœ²ç«¯å£
EXPOSE 22 8080 8888 6006

# è®¾ç½®å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]